{% extends "title_base.html"  %}
{% block title %}
{% load static %}
<link type="image/x-icon" rel="shortcut icon" href="{% static "favicon.ico" %}">
<link type="text/css" rel="stylesheet" href="{% static "css/common.css" %}">
<link type="text/css" rel="stylesheet" href="{% static "css/player.css" %}">
<link type="text/css" rel="stylesheet" href="{% static "css/play.css" %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    /* 播放页面现代化样式 */
    .music-player-container {
        display: flex;
        background: linear-gradient(45deg, #fff6d5, #fffbea);
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(252, 196, 25, 0.2);
        padding: 30px;
        margin: 20px auto;
        max-width: 1000px;
    }

    /* 音量控制弹出样式 */
    .volume-popup {
        position: absolute;
        bottom: 50px;
        right: -15px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        z-index: 10;
    }

    .volume-container {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        box-shadow: 0 2px 8px rgba(252, 196, 25, 0.2);
    }

    .player-left {
        width: 300px;
        padding-right: 30px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .player-right {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .album-cover {
        width: 280px;
        height: 280px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 8px 16px rgba(252, 196, 25, 0.3);
        position: relative;
        transition: transform 0.3s ease;
    }

    .album-cover:hover {
        transform: scale(1.02);
    }

    .album-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .song-info {
        width: 100%;
        padding: 20px 0;
        text-align: center;
    }

    .song-info h1 {
        font-size: 28px;
        margin-bottom: 10px;
        color: #a66a00;
    }

    .song-info .artist {
        font-size: 18px;
        color: #c97a0a;
        margin-bottom: 5px;
    }

    .song-info .album {
        font-size: 16px;
        color: #d17d00;
        margin-bottom: 15px;
    }

    .song-info .meta {
        display: flex;
        justify-content: center;
        font-size: 14px;
        color: #c97a0a;
        margin-top: 5px;
    }

    .song-info .meta span {
        margin: 0 10px;
    }

    .player-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        margin: 20px 0;
    }

    .control-button {
        background: none;
        border: none;
        color: #a66a00;
        font-size: 20px;
        cursor: pointer;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .control-button:hover {
        color: #ff9800;
    }

    .control-button.play-pause {
        background: #FFDF35;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 24px;
        box-shadow: 0 4px 10px rgba(252, 196, 25, 0.4);
    }

    .control-button.play-pause:hover {
        background: #fbc02d;
        transform: scale(1.05);
    }

    .progress-container {
        width: 100%;
        height: 6px;
        background-color: #ffe066;
        border-radius: 3px;
        margin: 20px 0;
        cursor: pointer;
        position: relative;
    }

    .progress-bar {
        height: 100%;
        background-color: #FFDF35;
        border-radius: 3px;
        position: relative;
    }

    .progress-thumb {
        width: 16px;
        height: 16px;
        background: #fbc02d;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        right: -8px;
        transform: translateY(-50%);
        box-shadow: 0 0 5px rgba(252, 196, 25, 0.5);
    }

    .time-info {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        color: #c97a0a;
    }

    .lyrics-container {
        flex: 1;
        margin-top: 20px;
        overflow-y: auto;
        max-height: 300px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 8px;
    }

    .lyrics-container::-webkit-scrollbar {
        width: 5px;
    }

    .lyrics-container .lrc-item {
        padding: 8px 0;
        color: #a66a00;
        text-align: center;
        transition: all 0.3s;
    }

    .lyrics-container .lrc-item.active {
        color: #ff9800;
        font-size: 16px;
        font-weight: bold;
    }

    .playlist-container {
        margin-top: 20px;
    }

    .playlist-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .playlist-header h3 {
        font-size: 18px;
        color: #a66a00;
    }

    .playlist-controls {
        display: flex;
    }

    .playlist-controls .control-button {
        margin-left: 10px;
        font-size: 16px;
        width: 30px;
        height: 30px;
    }

    .playlist {
        background: rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        max-height: 200px;
        overflow-y: auto;
    }

    .playlist li {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        border-bottom: 1px solid rgba(255, 223, 53, 0.2);
        transition: background 0.2s;
    }

    .playlist li:hover {
        background: rgba(255, 223, 53, 0.1);
    }

    .playlist li.current {
        background: rgba(255, 223, 53, 0.3);
    }

    .playlist .num {
        width: 25px;
        color: #c97a0a;
        font-size: 14px;
    }

    .playlist .name {
        flex: 1;
        color: #a66a00;
        font-size: 15px;
        margin-right: 10px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .playlist .singer {
        width: 120px;
        color: #c97a0a;
        font-size: 14px;
        text-align: right;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .volume-container {
        display: flex;
        align-items: center;
        margin: 10px 0;
    }

    .volume-icon {
        color: #a66a00;
        margin-right: 10px;
    }

    .volume-slider {
        flex: 1;
        height: 4px;
        background-color: #ffe066;
        border-radius: 2px;
        position: relative;
        cursor: pointer;
    }

    .volume-progress {
        height: 100%;
        background-color: #FFDF35;
        border-radius: 2px;
        position: relative;
    }

    .volume-thumb {
        width: 12px;
        height: 12px;
        background: #fbc02d;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        right: -6px;
        transform: translateY(-50%);
    }

    .related-songs {
        margin-top: 30px;
    }

    .related-songs h3 {
        font-size: 20px;
        color: #a66a00;
        margin-bottom: 15px;
        border-left: 4px solid #FFDF35;
        padding-left: 10px;
    }

    .related-songs-list {
        display: flex;
        overflow-x: auto;
        padding: 10px 0;
    }

    .related-songs-list::-webkit-scrollbar {
        height: 8px;
    }

    .related-song-item {
        width: 160px;
        margin-right: 15px;
        flex-shrink: 0;
        transition: transform 0.2s;
    }

    .related-song-item:hover {
        transform: translateY(-5px);
    }

    .related-song-cover {
        width: 160px;
        height: 160px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(252, 196, 25, 0.2);
    }

    .related-song-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .related-song-info {
        margin-top: 10px;
        text-align: center;
    }

    .related-song-info h4 {
        font-size: 15px;
        color: #a66a00;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .related-song-info p {
        font-size: 14px;
        color: #c97a0a;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .action-buttons {
        display: flex;
        margin: 15px 0;
    }

    .action-button {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px 15px;
        background: #FFDF35;
        color: #fff;
        border: none;
        border-radius: 20px;
        font-size: 15px;
        font-weight: bold;
        margin-right: 15px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 3px 8px rgba(252, 196, 25, 0.3);
    }

    .action-button i {
        margin-right: 5px;
    }

    .action-button:hover {
        background: #fbc02d;
        transform: translateY(-2px);
    }

    /* 兼容原有播放器隐藏部分 */
    #jquery_jplayer_1, #jp_container_1 {
        position: absolute;
        visibility: hidden;
        height: 0;
        width: 0;
    }
    
    .jp-jplayer audio {
        width: 0 !important;
        height: 0 !important;
    }
    
    /* 隐藏原歌词区域 */
    .jplayer_content {
        display: none;
    }

    .toast {
        position: fixed;
        left: 50%;
        bottom: -100px;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 25px;
        border-radius: 30px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        z-index: 10000;
        transition: all 0.5s ease;
    }

    .toast.show {
        bottom: 30px;
        animation: fadeInUp 0.5s ease;
    }

    .toast-content {
        display: flex;
        align-items: center;
    }

    .toast-content i {
        color: #4CAF50;
        font-size: 20px;
        margin-right: 10px;
    }

    @keyframes fadeInUp {
        from {
            transform: translate(-50%, 20px);
            opacity: 0;
        }
        to {
            transform: translate(-50%, 0);
            opacity: 1;
        }
    }

    /* 添加歌曲操作区域的样式 */
    .song-actions {
        margin: 20px auto;
        max-width: 1000px;
    }
    
    .btn_area {
        display: flex;
        justify-content: center;
        gap: 20px;
    }
    
    .action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: #a66a00;
        transition: all 0.3s ease;
        padding: 15px;
        border-radius: 10px;
        background: linear-gradient(45deg, #fff6d5, #fffbea);
        box-shadow: 0 4px 10px rgba(252, 196, 25, 0.2);
        width: 80px;
    }
    
    .action-btn i {
        font-size: 24px;
        margin-bottom: 8px;
    }
    
    .action-btn span {
        font-size: 14px;
    }
    
    .action-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 15px rgba(252, 196, 25, 0.3);
        color: #ff9800;
    }
    
    .btn-love:hover {
        background: #ffe6e6;
        color: #ff4081;
    }
    
    .btn-comment:hover {
        background: #e6f7ff;
        color: #2196f3;
    }
    
    .btn-download:hover {
        background: #e6ffe6;
        color: #4caf50;
    }
    
    .btn-collect:hover {
        background: #fff2e6;
        color: #ff9800;
    }
</style>
{% endblock %}

{% block content %}
<body class="windows">
	<div class="header">
		<a href="/" class="logo" title="首页"><img src="{% static "image/logo2.png" %}"></a>
		<div class="search-box">
			<!-- 歌曲查询 -->
            <form id="searchForm" action="{% url 'search' 1 %}" method="post" target="_blank">
            {% csrf_token %}
            <div class="search-keyword">
              <input id="kword" name="kword" type="text" class="keyword" maxlength="120" placeholder="音乐节"  />
            </div>
            <input id="subSerch" type="submit" class="search-button" value="搜 索" />
            </form>
            <div id="suggest" class="search-suggest"></div>
            <div class="search-hot-words">
                {% for song in search_song  %}
                <a target="play" href="{% url 'play' song.song.song_id %}" >{{ song.song.song_name }}</a>
                {% endfor  %}
            </div>
		</div>
	</div><!--end header-->
	<div class="nav-box">
		<div class="nav-box-inner">
			<ul class="nav clearfix">
				<li><a href="/">首页</a></li>
				<li><a href="{% url 'ranking' %}" target="_blank">歌曲排行</a></li>
	    	    <li><a href="{% url 'home' 1 %}" target="_blank">用户中心</a></li>
			</ul>
		</div>
	</div><!--end nav-box-->
	
	<!-- 现代化播放器界面 -->
    <div class="music-player-container">
        <!-- 左侧专辑图片和歌曲信息 -->
        <div class="player-left">
            <div class="album-cover">
                {% if song_info.song_img_url %}
                    <img src="{{ song_info.song_img_url }}" alt="{{ song_info.song_name }}">
                {% else %}
                    <img src="{% static "songImg/" %}{{ song_info.song_img }}" alt="{{ song_info.song_name }}">
                {% endif %}
            </div>
            <div class="song-info">
                <h1 id="currentSong">{{ song_info.song_name }}</h1>
                <div class="artist">{{ song_info.song_singer }}</div>
                <div class="album">专辑：{{ song_info.song_album }}</div>
                <div class="meta">
                    <span>语种：{{ song_info.song_languages }}</span>
                    <span>流派：{{ song_info.song_type }}</span>
                </div>
                <div class="meta">
                    <span>发行时间：{{ song_info.song_release }}</span>
                </div>
            </div>
            
            <div class="action-buttons">
                <a class="action-button download-btn" href="{% url 'download' song_info.song_id %}">
                    <i class="fas fa-download"></i> 下载
                </a>
                <a class="action-button comment-btn" href="{% url 'comment' song_info.song_id %}" target="_blank">
                    <i class="fas fa-comment"></i> 点评
                </a>
            </div>
        </div>
        
        <!-- 右侧播放控制和歌词 -->
        <div class="player-right">
            <!-- 进度条和控制按钮 -->
            <div class="progress-container">
                <div class="progress-bar" style="width: 0%">
                    <div class="progress-thumb"></div>
                </div>
            </div>
            
            <div class="time-info">
                <span class="current-time">00:00</span>
                <span class="total-time">00:00</span>
            </div>
            
            <div class="player-controls">
                <button class="control-button mode-button" title="播放模式">
                    <i class="fas fa-retweet"></i>
                </button>
                <button class="control-button prev-button" title="上一首">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button class="control-button play-pause" title="播放/暂停">
                    <i class="fas fa-play play-icon"></i>
                    <i class="fas fa-pause pause-icon" style="display:none"></i>
                </button>
                <button class="control-button next-button" title="下一首">
                    <i class="fas fa-step-forward"></i>
                </button>
                <button class="control-button volume-button" title="音量">
                    <i class="fas fa-volume-up"></i>
                </button>
                
                <div class="volume-popup">
                    <div class="volume-container">
                        <div class="volume-icon">
                            <i class="fas fa-volume-up"></i>
                        </div>
                        <div class="volume-slider">
                            <div class="volume-progress" style="width: 80%" data-previous-volume="0.8">
                                <div class="volume-thumb"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 歌词显示 -->
            <div class="lyrics-container" id="modernLyrics">
                <!-- 歌词将通过JS动态加载 -->
            </div>
            
            <!-- 播放列表 -->
            <div class="playlist-container">
                <div class="playlist-header">
                    <h3>当前播放列表</h3>
                    <div class="playlist-controls">
                        <button class="control-button" id="orderPlay" title="顺序播放">
                            <i class="fas fa-list-ul"></i>
                        </button>
                        <button class="control-button" id="singlePlay" title="单曲循环">
                            <i class="fas fa-redo-alt"></i>
                        </button>
                        <button class="control-button" id="randomPlay" title="随机播放">
                            <i class="fas fa-random"></i>
                        </button>
                    </div>
                </div>
                
                <ul class="playlist">
                    {% for list in play_list %}
                    {%if list.song_id == song_info.song_id %}
                    <li data-id="{{list.song_id}}" class="current">
                    {%else %}
                    <li data-id="{{list.song_id}}">
                    {%endif %}
                    <span class="num">{{forloop.counter}}</span>
                    <a class="name" href="{% url 'play' list.song_id %}" target="play" >{{list.song_name}}</a>
                    <a class="singer" href="javascript:;" target="_blank" >{{list.song_singer}}</a>
                    </li>
                    {%endfor %}
                </ul>
            </div>
        </div>
    </div>
    
    <!-- 相关推荐 -->
    <div class="related-songs">
        <h3>相关歌曲</h3>
        <div class="related-songs-list">
            {% for item in song_relevant %}
            {% if item.song.song_id != song_info.song_id %}
            <div class="related-song-item">
                <a href="{% url 'play' item.song.song_id %}" class="related-song-cover">
                    {% if item.song.song_img_url %}
                        <img src="{{ item.song.song_img_url }}" alt="{{ item.song.song_name }}">
                    {% else %}
                        <img src="{% static "songImg/" %}{{ item.song.song_img }}" alt="{{ item.song.song_name }}">
                    {% endif %}
                </a>
                <div class="related-song-info">
                    <h4><a href="{% url 'play' item.song.song_id %}" target="play">{{ item.song.song_name }}</a></h4>
                    <p>{{ item.song.song_singer }}</p>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- 原播放器组件（保留以确保原有功能可用） -->
    <div style="display:none;">
        <div class="content">
            <div class="product-detail-box clearfix">
                <div class="product-pics">
                    <div class="music_box">
                        <div id="jquery_jplayer_1" class="jp-jplayer" data-url="{% static "songFile/" %}{{ song_file_name }}"></div>
                        <div class="jp_img layz_load pic_po" title="点击播放">
                            {% if song_info.song_img_url %}
                                <img data-src="{{ song_info.song_img_url }}">
                            {% else %}
                                <img data-src="{% static "songImg/" %}{{ song_info.song_img }}">
                            {% endif %}
                        </div>
                        <div id="jp_container_1" class="jp-audio">
                            <div class="jp-gui jp-interface">
                                <div class="jp-time-holder clearfix">
                                    <div class="jp-progress">
                                        <div class="jp-seek-bar">
                                            <div class="jp-play-bar"></div>
                                        </div>
                                    </div>
                                    <div class="jp-time">
                                        <span class="jp-current-time"></span> /
                                        <span class="jp-duration"></span>
                                    </div>
                                </div>
                                <div class="song_error_corr" id="songCorr">
                                    <b class="err_btn">纠错</b>
                                    <ul>
                                        <li><span>歌词文本错误</span></li>
                                        <li><span>歌词时间错误</span></li>
                                        <li><span>歌曲错误</span></li>
                                    </ul>
                                </div>
                                <div class="jp-volume-bar">
                                    <div class="jp-volume-bar-value"></div>
                                </div>
                                <ul class="jp-controls clearfix">
                                    <li><a class="jp-play" tabindex="1" title="play"></a><a class="jp-pause" tabindex="1" title="pause"></a></li>
                                    <li><a class="jp-stop" tabindex="1" title="stop"></a></li>
                                    <li><a class="jp-repeat" tabindex="1" title="repeat"></a><a class="jp-repeat-off" tabindex="1" title="repeat off"></a></li>
                                    <li class="sound"><a class="jp-mute" tabindex="1" title="mute"></a><a class="jp-unmute" tabindex="1" title="unmute"></a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="jplayer_content">
                            <ul id="lrc_list" class="lrc_list"></ul>
                        </div>
                    </div><!--end music_box-->
                    <textarea id="lrc_content" style="display: none;">
                      {{ song_lyrics }}
                    </textarea>
                </div><!--end product-pics-->
            </div>
        </div>
    </div>

    <!-- 成功提示弹窗 -->
    <div id="success-toast" class="toast">
        <div class="toast-content">
            <i class="fas fa-check-circle"></i>
            <span id="toast-message">操作成功</span>
        </div>
    </div>

    <!-- 歌曲操作区域，添加新的点评按钮 -->
    <div class="song-actions">
        <div class="btn_area">
            <a href="javascript:;" class="action-btn btn-love">
                <i class="fas fa-heart"></i>
                <span>喜欢</span>
            </a>
            <a href="/comment/{{ song_info.song_id }}.html" class="action-btn btn-comment">
                <i class="fas fa-comment"></i>
                <span>点评</span>
            </a>
            <a href="/download/{{ song_info.song_id }}.html" class="action-btn btn-download">
                <i class="fas fa-download"></i>
                <span>下载</span>
            </a>
            <a href="javascript:;" class="action-btn btn-collect">
                <i class="fas fa-plus"></i>
                <span>收藏</span>
            </a>
        </div>
    </div>

	<script data-main="{% static "js/play.js" %}" src="{% static "js/require.js" %}"></script>
    <!-- 现代播放器交互脚本 -->
    <script>
        // 图片加载错误处理
        document.addEventListener('DOMContentLoaded', function() {
            // 处理所有图片加载错误
            const handleImageError = function(img) {
                img.onerror = function() {
                    // 如果是logo图片
                    if (img.parentElement.classList.contains('logo')) {
                        this.src = "{% static 'image/newlogo.png' %}";
                    }
                    // 如果是专辑图片
                    else if (this.parentElement.classList.contains('album-cover')) {
                        this.src = "{% static 'image/default_album.png' %}";
                    }
                    // 其他图片
                    else {
                        this.src = "{% static 'image/default_album.png' %}";
                    }
                    return true;
                };
            };
            
            // 为所有图片添加错误处理
            const images = document.querySelectorAll('img');
            images.forEach(function(img) {
                handleImageError(img);
            });
        });

        // 等页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 等待原播放器初始化完成
            setTimeout(function() {
                // 监听播放按钮点击
                document.querySelector('.play-pause').addEventListener('click', function() {
                    const playIcon = document.querySelector('.play-icon');
                    const pauseIcon = document.querySelector('.pause-icon');
                    
                    if (playIcon.style.display !== 'none') {
                        // 当前是暂停状态，需要播放
                        document.querySelector('.jp-play').click();
                        playIcon.style.display = 'none';
                        pauseIcon.style.display = 'inline-block';
                    } else {
                        // 当前是播放状态，需要暂停
                        document.querySelector('.jp-pause').click();
                        playIcon.style.display = 'inline-block';
                        pauseIcon.style.display = 'none';
                    }
                });
                
                // 上一首、下一首
                document.querySelector('.prev-button').addEventListener('click', function() {
                    let playList = document.querySelectorAll('.playlist li');
                    let currentIndex = -1;
                    
                    // 找到当前播放歌曲的索引
                    playList.forEach((item, index) => {
                        if (item.classList.contains('current')) {
                            currentIndex = index;
                        }
                    });
                    
                    if (currentIndex > 0) {
                        // 有上一首歌曲
                        let prevSong = playList[currentIndex - 1].querySelector('.name');
                        if (prevSong) {
                            prevSong.click();
                        }
                    }
                });
                
                document.querySelector('.next-button').addEventListener('click', function() {
                    let playList = document.querySelectorAll('.playlist li');
                    let currentIndex = -1;
                    
                    // 找到当前播放歌曲的索引
                    playList.forEach((item, index) => {
                        if (item.classList.contains('current')) {
                            currentIndex = index;
                        }
                    });
                    
                    if (currentIndex >= 0 && currentIndex < playList.length - 1) {
                        // 有下一首歌曲
                        let nextSong = playList[currentIndex + 1].querySelector('.name');
                        if (nextSong) {
                            nextSong.click();
                        }
                    }
                });
                
                // 拖动音量滑块调整音量
                const volumeSlider = document.querySelector('.volume-slider');
                const volumeProgress = document.querySelector('.volume-progress');
                const volumeThumb = document.querySelector('.volume-thumb');
                const volumePopup = document.querySelector('.volume-popup');
                
                let isVolumeDragging = false;
                let volumeHideTimeout;
                
                // 音量按钮点击显示/隐藏音量控制
                document.querySelector('.volume-button').addEventListener('click', function() {
                    // 切换显示状态
                    if (volumePopup.style.opacity === '1') {
                        volumePopup.style.opacity = '0';
                        volumePopup.style.visibility = 'hidden';
                    } else {
                        volumePopup.style.opacity = '1';
                        volumePopup.style.visibility = 'visible';
                        
                        // 3秒后自动隐藏
                        clearTimeout(volumeHideTimeout);
                        volumeHideTimeout = setTimeout(function() {
                            volumePopup.style.opacity = '0';
                            volumePopup.style.visibility = 'hidden';
                        }, 3000);
                    }
                });
                
                volumeSlider.addEventListener('mousedown', function(e) {
                    isVolumeDragging = true;
                    updateVolumePosition(e);
                    // 清除任何现有的隐藏计时器
                    clearTimeout(volumeHideTimeout);
                });
                
                document.addEventListener('mousemove', function(e) {
                    if (isVolumeDragging) {
                        updateVolumePosition(e);
                    }
                });
                
                document.addEventListener('mouseup', function() {
                    if (isVolumeDragging) {
                        isVolumeDragging = false;
                        
                        // 设置2秒后自动隐藏
                        volumeHideTimeout = setTimeout(function() {
                            volumePopup.style.opacity = '0';
                            volumePopup.style.visibility = 'hidden';
                        }, 2000);
                    }
                });
                
                // 点击音量滑块调整音量
                volumeSlider.addEventListener('click', function(e) {
                    if (isVolumeDragging) return; // 如果正在拖动则不处理点击
                    
                    const boundingRect = this.getBoundingClientRect();
                    const clickPosition = e.clientX - boundingRect.left;
                    const volumePercent = (clickPosition / this.clientWidth) * 100;
                    
                    volumeProgress.style.width = volumePercent + '%';
                    
                    // 调整原播放器音量
                    if (typeof jQuery !== 'undefined' && jQuery("#jquery_jplayer_1").length) {
                        jQuery("#jquery_jplayer_1").jPlayer("volume", volumePercent / 100);
                    }
                    
                    // 设置2秒后自动隐藏
                    clearTimeout(volumeHideTimeout);
                    volumeHideTimeout = setTimeout(function() {
                        volumePopup.style.opacity = '0';
                        volumePopup.style.visibility = 'hidden';
                    }, 2000);
                });
                
                function updateVolumePosition(e) {
                    if (!isVolumeDragging) return;
                    
                    const boundingRect = volumeSlider.getBoundingClientRect();
                    let clickPosition = e.clientX - boundingRect.left;
                    
                    // 确保在容器范围内
                    if (clickPosition < 0) clickPosition = 0;
                    if (clickPosition > boundingRect.width) clickPosition = boundingRect.width;
                    
                    const volumePercent = (clickPosition / boundingRect.width) * 100;
                    
                    // 更新音量条显示
                    volumeProgress.style.width = volumePercent + '%';
                    
                    // 调整原播放器音量
                    if (typeof jQuery !== 'undefined' && jQuery("#jquery_jplayer_1").length) {
                        jQuery("#jquery_jplayer_1").jPlayer("volume", volumePercent / 100);
                    }
                }
                
                // 音量图标点击切换静音
                document.querySelector('.volume-container .volume-icon').addEventListener('click', function(event) {
                    // 获取当前音量图标
                    const volumeIcon = this.querySelector('i');
                    const volumeButtonIcon = document.querySelector('.volume-button i');
                    const isMuted = volumeIcon.classList.contains('fa-volume-mute');
                    
                    // 切换静音状态
                    if (isMuted) {
                        // 恢复音量
                        volumeIcon.classList.remove('fa-volume-mute');
                        volumeIcon.classList.add('fa-volume-up');
                        volumeButtonIcon.classList.remove('fa-volume-mute');
                        volumeButtonIcon.classList.add('fa-volume-up');
                        
                        // 获取之前的音量值或默认为80%
                        const previousVolume = parseFloat(volumeProgress.getAttribute('data-previous-volume') || 0.8);
                        volumeProgress.style.width = (previousVolume * 100) + '%';
                        
                        if (typeof jQuery !== 'undefined' && jQuery("#jquery_jplayer_1").length) {
                            jQuery("#jquery_jplayer_1").jPlayer("volume", previousVolume);
                        }
                    } else {
                        // 静音
                        volumeIcon.classList.remove('fa-volume-up');
                        volumeIcon.classList.add('fa-volume-mute');
                        volumeButtonIcon.classList.remove('fa-volume-up');
                        volumeButtonIcon.classList.add('fa-volume-mute');
                        
                        // 保存当前音量
                        const currentWidth = volumeProgress.style.width;
                        const currentVolume = parseFloat(currentWidth) / 100 || 0.8;
                        volumeProgress.setAttribute('data-previous-volume', currentVolume);
                        
                        // 设置音量为0
                        volumeProgress.style.width = '0%';
                        
                        if (typeof jQuery !== 'undefined' && jQuery("#jquery_jplayer_1").length) {
                            jQuery("#jquery_jplayer_1").jPlayer("volume", 0);
                        }
                    }
                    
                    // 阻止事件冒泡，防止触发父元素的点击事件
                    event.stopPropagation();
                });
                
                // 播放模式
                document.getElementById('orderPlay').addEventListener('click', function() {
                    // 顺序播放
                    document.getElementById('playleixin').querySelector('.order a').click();
                });
                
                document.getElementById('singlePlay').addEventListener('click', function() {
                    // 单曲循环
                    document.getElementById('playleixin').querySelector('.single a').click();
                });
                
                document.getElementById('randomPlay').addEventListener('click', function() {
                    // 随机播放
                    document.getElementById('playleixin').querySelector('.random a').click();
                });
                
                // 解析歌词并显示
                function parseLyrics() {
                    const lyricsText = document.getElementById('lrc_content').value;
                    const lyricsContainer = document.getElementById('modernLyrics');
                    
                    if (!lyricsText.trim()) {
                        lyricsContainer.innerHTML = '<p class="lrc-item">暂无歌词</p>';
                        return;
                    }
                    
                    const lines = lyricsText.split('\n');
                    const lyricsHtml = [];
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line) {
                            // 从原歌词格式中提取文本
                            const parts = line.match(/^\[(\d{2}):(\d{2})\.(\d{2})\](.*)$/);
                            if (parts && parts[4]) {
                                const text = parts[4].trim();
                                if (text) {
                                    lyricsHtml.push(`<p class="lrc-item" data-time="${parts[1]}:${parts[2]}">${text}</p>`);
                                }
                            } else if (line.indexOf('[') === -1) {
                                // 无时间戳的纯文本行
                                lyricsHtml.push(`<p class="lrc-item">${line}</p>`);
                            }
                        }
                    }
                    
                    lyricsContainer.innerHTML = lyricsHtml.join('');
                }
                
                // 同步进度条和歌词
                function syncProgress() {
                    setInterval(function() {
                        // 获取原播放器的当前时间和总时间
                        const currentTime = document.querySelector('.jp-current-time').textContent;
                        const duration = document.querySelector('.jp-duration').textContent;
                        
                        // 更新现代播放器的时间显示
                        document.querySelector('.current-time').textContent = currentTime;
                        document.querySelector('.total-time').textContent = duration;
                        
                        // 更新进度条
                        if (currentTime && duration && duration !== '00:00') {
                            const currentTimeParts = currentTime.split(':');
                            const durationParts = duration.split(':');
                            
                            const currentSeconds = parseInt(currentTimeParts[0]) * 60 + parseInt(currentTimeParts[1]);
                            const totalSeconds = parseInt(durationParts[0]) * 60 + parseInt(durationParts[1]);
                            
                            if (totalSeconds > 0) {
                                const progressPercent = (currentSeconds / totalSeconds) * 100;
                                document.querySelector('.progress-bar').style.width = progressPercent + '%';
                            }
                        }
                        
                        // 高亮当前歌词
                        highlightCurrentLyric(currentTime);
                    }, 500);
                }
                
                // 高亮当前歌词
                function highlightCurrentLyric(currentTime) {
                    const lyrics = document.querySelectorAll('.lrc-item');
                    if (!lyrics.length) return;
                    
                    // 找到当前应该高亮的歌词
                    const currentTimeParts = currentTime.split(':');
                    const currentMinutes = parseInt(currentTimeParts[0]);
                    const currentSeconds = parseInt(currentTimeParts[1]);
                    
                    let activeIndex = -1;
                    
                    lyrics.forEach((lyric, index) => {
                        const timeAttr = lyric.getAttribute('data-time');
                        if (timeAttr) {
                            const lyricTimeParts = timeAttr.split(':');
                            const lyricMinutes = parseInt(lyricTimeParts[0]);
                            const lyricSeconds = parseInt(lyricTimeParts[1]);
                            
                            if ((lyricMinutes < currentMinutes) || 
                                (lyricMinutes === currentMinutes && lyricSeconds <= currentSeconds)) {
                                activeIndex = index;
                            }
                        }
                    });
                    
                    // 移除所有高亮
                    lyrics.forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // 添加高亮到当前行
                    if (activeIndex >= 0) {
                        lyrics[activeIndex].classList.add('active');
                        
                        // 滚动到可见区域
                        const container = document.querySelector('.lyrics-container');
                        const activeElement = lyrics[activeIndex];
                        
                        const containerHeight = container.clientHeight;
                        const activePosition = activeElement.offsetTop - container.scrollTop;
                        
                        if (activePosition < 80 || activePosition > containerHeight - 40) {
                            container.scrollTo({
                                top: activeElement.offsetTop - containerHeight / 2,
                                behavior: 'smooth'
                            });
                        }
                    }
                }
                
                // 初始化播放状态
                function initPlayState() {
                    // 监听原播放器的播放状态
                    const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.target.classList.contains('jp-play')) {
                                const display = window.getComputedStyle(mutation.target).display;
                                const playIcon = document.querySelector('.play-icon');
                                const pauseIcon = document.querySelector('.pause-icon');
                                
                                if (display === 'none') {
                                    // 播放中
                                    playIcon.style.display = 'none';
                                    pauseIcon.style.display = 'inline-block';
                                } else {
                                    // 暂停
                                    playIcon.style.display = 'inline-block';
                                    pauseIcon.style.display = 'none';
                                }
                            }
                        });
                    });
                    
                    const jpPlay = document.querySelector('.jp-play');
                    if (jpPlay) {
                        observer.observe(jpPlay, { attributes: true });
                    }
                }
                
                // 初始化进度条功能
                function initProgressBar() {
                    // 监听jPlayer的timeupdate事件，确保进度条更新与播放器同步
                    jQuery("#jquery_jplayer_1").bind(jQuery.jPlayer.event.timeupdate, function(event) {
                        const percent = event.jPlayer.status.currentPercentRelative;
                        if (!isDragging) {
                            document.querySelector('.progress-bar').style.width = percent + '%';
                        }
                    });
                    
                    // 监听jPlayer的播放/暂停事件
                    jQuery("#jquery_jplayer_1").bind(jQuery.jPlayer.event.play, function(event) {
                        const playIcon = document.querySelector('.play-icon');
                        const pauseIcon = document.querySelector('.pause-icon');
                        playIcon.style.display = 'none';
                        pauseIcon.style.display = 'inline-block';
                    });
                    
                    jQuery("#jquery_jplayer_1").bind(jQuery.jPlayer.event.pause, function(event) {
                        const playIcon = document.querySelector('.play-icon');
                        const pauseIcon = document.querySelector('.pause-icon');
                        playIcon.style.display = 'inline-block';
                        pauseIcon.style.display = 'none';
                    });
                    
                    // 增强进度条功能
                    enhanceProgressControl();
                    
                    // 增强下一首按钮功能
                    enhanceNextButtonControl();
                }
                
                // 增强进度条控制功能
                function enhanceProgressControl() {
                    // 替换原有的点击进度条事件处理
                    const progressContainer = document.querySelector('.progress-container');
                    progressContainer.removeEventListener('click', progressContainer.clickHandler);
                    
                    progressContainer.clickHandler = function(e) {
                        const boundingRect = this.getBoundingClientRect();
                        const clickPosition = e.clientX - boundingRect.left;
                        const progressPercent = (clickPosition / this.clientWidth) * 100;
                        
                        // 更新进度条显示
                        document.querySelector('.progress-bar').style.width = progressPercent + '%';
                        
                        // 使用多种方法尝试调整进度
                        if (typeof jQuery !== 'undefined' && jQuery("#jquery_jplayer_1").length) {
                            try {
                                const jPlayer = jQuery("#jquery_jplayer_1");
                                const status = jPlayer.data("jPlayer").status;
                                
                                // 检查播放器是否已准备好
                                if (status.srcSet) {
                                    // 记住当前是否正在播放
                                    const wasPlaying = !status.paused;
                                    
                                    // 方法1：使用playHead方法设置位置
                                    jPlayer.jPlayer("playHead", progressPercent);
                                    
                                    // 方法2：如果方法1失败，尝试使用seek方法
                                    setTimeout(function() {
                                        if (Math.abs(jPlayer.data("jPlayer").status.currentPercentRelative - progressPercent) > 5) {
                                            const duration = jPlayer.data("jPlayer").status.duration;
                                            const seekTime = duration * (progressPercent / 100);
                                            jPlayer.jPlayer("play", seekTime);
                                        }
                                        
                                        // 如果之前在播放，确保继续播放
                                        if (wasPlaying) {
                                            setTimeout(function() {
                                                jPlayer.jPlayer("play");
                                            }, 100);
                                        }
                                    }, 100);
                                }
                            } catch (err) {
                                console.log("进度调整失败:", err);
                                // 尝试直接操作原始audio元素
                                try {
                                    const audioElement = document.querySelector("audio");
                                    if (audioElement) {
                                        const duration = audioElement.duration;
                                        if (duration && !isNaN(duration)) {
                                            audioElement.currentTime = duration * (progressPercent / 100);
                                        }
                                    }
                                } catch (audioErr) {
                                    console.log("直接操作audio元素失败:", audioErr);
                                }
                            }
                        }
                    };
                    
                    progressContainer.addEventListener('click', progressContainer.clickHandler);
                    
                    // 替换拖动进度条的实现
                    document.removeEventListener('mousemove', document.progressMoveHandler);
                    document.removeEventListener('mouseup', document.progressUpHandler);
                    
                    document.progressMoveHandler = function(e) {
                        if (isDragging) {
                            const boundingRect = progressContainer.getBoundingClientRect();
                            let clickPosition = e.clientX - boundingRect.left;
                            
                            // 确保在容器范围内
                            if (clickPosition < 0) clickPosition = 0;
                            if (clickPosition > boundingRect.width) clickPosition = boundingRect.width;
                            
                            const progressPercent = (clickPosition / boundingRect.width) * 100;
                            
                            // 更新进度条显示
                            document.querySelector('.progress-bar').style.width = progressPercent + '%';
                            
                            // 获取总时间并更新显示的当前时间
                            if (typeof jQuery !== 'undefined' && jQuery("#jquery_jplayer_1").length) {
                                try {
                                    const duration = jQuery("#jquery_jplayer_1").data("jPlayer").status.duration;
                                    if (duration && !isNaN(duration)) {
                                        const newPosition = duration * (progressPercent / 100);
                                        const newMinutes = Math.floor(newPosition / 60).toString().padStart(2, '0');
                                        const newSeconds = Math.floor(newPosition % 60).toString().padStart(2, '0');
                                        
                                        // 更新当前时间显示
                                        document.querySelector('.current-time').textContent = `${newMinutes}:${newSeconds}`;
                                    }
                                } catch (err) {
                                    console.log("获取时间信息失败:", err);
                                }
                            }
                        }
                    };
                    
                    document.progressUpHandler = function() {
                        if (isDragging) {
                            isDragging = false;
                            
                            // 获取当前进度条位置
                            const progressPercent = parseFloat(document.querySelector('.progress-bar').style.width);
                            
                            // 使用多种方法尝试调整进度
                            if (typeof jQuery !== 'undefined' && jQuery("#jquery_jplayer_1").length) {
                                try {
                                    const jPlayer = jQuery("#jquery_jplayer_1");
                                    
                                    // 方法1：使用playHead方法设置位置
                                    jPlayer.jPlayer("playHead", progressPercent);
                                    
                                    // 方法2：如果方法1失败，尝试使用seek方法
                                    setTimeout(function() {
                                        if (Math.abs(jPlayer.data("jPlayer").status.currentPercentRelative - progressPercent) > 5) {
                                            const duration = jPlayer.data("jPlayer").status.duration;
                                            const seekTime = duration * (progressPercent / 100);
                                            jPlayer.jPlayer("play", seekTime);
                                        }
                                        
                                        // 如果之前是播放状态，恢复播放
                                        if (!wasPaused) {
                                            setTimeout(function() {
                                                jPlayer.jPlayer("play");
                                            }, 100);
                                        }
                                    }, 100);
                                } catch (err) {
                                    console.log("进度调整失败:", err);
                                    // 尝试直接操作原始audio元素
                                    try {
                                        const audioElement = document.querySelector("audio");
                                        if (audioElement) {
                                            const duration = audioElement.duration;
                                            if (duration && !isNaN(duration)) {
                                                audioElement.currentTime = duration * (progressPercent / 100);
                                                if (!wasPaused) {
                                                    audioElement.play();
                                                }
                                            }
                                        }
                                    } catch (audioErr) {
                                        console.log("直接操作audio元素失败:", audioErr);
                                    }
                                }
                            }
                        }
                    };
                    
                    document.addEventListener('mousemove', document.progressMoveHandler);
                    document.addEventListener('mouseup', document.progressUpHandler);
                }
                
                // 增强下一首按钮功能
                function enhanceNextButtonControl() {
                    // 替换原有的下一首按钮事件处理
                    const nextButton = document.querySelector('.next-button');
                    nextButton.removeEventListener('click', nextButton.clickHandler);
                    
                    nextButton.clickHandler = function() {
                        let playList = document.querySelectorAll('.playlist li');
                        let currentIndex = -1;
                        
                        // 找到当前播放歌曲的索引
                        playList.forEach((item, index) => {
                            if (item.classList.contains('current')) {
                                currentIndex = index;
                            }
                        });
                        
                        if (currentIndex >= 0 && currentIndex < playList.length - 1) {
                            // 有下一首歌曲
                            let nextSong = playList[currentIndex + 1].querySelector('.name');
                            if (nextSong) {
                                // 使用多种方式尝试跳转到下一首
                                try {
                                    // 方法1：直接点击链接
                                    nextSong.click();
                                } catch (err) {
                                    console.log("点击下一首失败:", err);
                                    
                                    // 方法2：直接修改location
                                    try {
                                        const nextUrl = nextSong.getAttribute('href');
                                        if (nextUrl) {
                                            window.location.href = nextUrl;
                                        }
                                    } catch (navErr) {
                                        console.log("导航到下一首失败:", navErr);
                                    }
                                }
                            }
                        } else if (playList.length > 0) {
                            // 如果是最后一首，根据播放模式决定行为
                            const playMode = localStorage.getItem('playRule') || 'order';
                            
                            if (playMode === 'order' || playMode === 'random') {
                                // 顺序播放或随机播放模式下，回到第一首
                                let firstSong = playList[0].querySelector('.name');
                                if (firstSong) {
                                    try {
                                        firstSong.click();
                                    } catch (err) {
                                        console.log("点击第一首失败:", err);
                                        try {
                                            const firstUrl = firstSong.getAttribute('href');
                                            if (firstUrl) {
                                                window.location.href = firstUrl;
                                            }
                                        } catch (navErr) {
                                            console.log("导航到第一首失败:", navErr);
                                        }
                                    }
                                }
                            }
                        }
                    };
                    
                    nextButton.addEventListener('click', nextButton.clickHandler);
                    
                    // 同样增强上一首按钮
                    const prevButton = document.querySelector('.prev-button');
                    prevButton.removeEventListener('click', prevButton.clickHandler);
                    
                    prevButton.clickHandler = function() {
                        let playList = document.querySelectorAll('.playlist li');
                        let currentIndex = -1;
                        
                        // 找到当前播放歌曲的索引
                        playList.forEach((item, index) => {
                            if (item.classList.contains('current')) {
                                currentIndex = index;
                            }
                        });
                        
                        if (currentIndex > 0) {
                            // 有上一首歌曲
                            let prevSong = playList[currentIndex - 1].querySelector('.name');
                            if (prevSong) {
                                try {
                                    prevSong.click();
                                } catch (err) {
                                    console.log("点击上一首失败:", err);
                                    try {
                                        const prevUrl = prevSong.getAttribute('href');
                                        if (prevUrl) {
                                            window.location.href = prevUrl;
                                        }
                                    } catch (navErr) {
                                        console.log("导航到上一首失败:", navErr);
                                    }
                                }
                            }
                        } else if (playList.length > 0) {
                            // 如果是第一首，循环到最后一首
                            let lastSong = playList[playList.length - 1].querySelector('.name');
                            if (lastSong) {
                                try {
                                    lastSong.click();
                                } catch (err) {
                                    console.log("点击最后一首失败:", err);
                                    try {
                                        const lastUrl = lastSong.getAttribute('href');
                                        if (lastUrl) {
                                            window.location.href = lastUrl;
                                        }
                                    } catch (navErr) {
                                        console.log("导航到最后一首失败:", navErr);
                                    }
                                }
                            }
                        }
                    };
                    
                    prevButton.addEventListener('click', prevButton.clickHandler);
                }
                
                // 初始化
                parseLyrics();
                syncProgress();
                initPlayState();
                
                // 确保播放器加载完成
                checkPlayerReady();
                
                // 播放器状态检测
                function checkPlayerReady() {
                    let checkAttempts = 0;
                    const maxAttempts = 20; // 最多尝试20次
                    
                    const checkInterval = setInterval(function() {
                        if (typeof jQuery !== 'undefined' && 
                            jQuery("#jquery_jplayer_1").length && 
                            jQuery("#jquery_jplayer_1").data("jPlayer")) {
                            
                            // 播放器已加载，初始化进度条
                            initProgressBar();
                            clearInterval(checkInterval);
                            console.log("播放器已准备就绪");
                        } else {
                            checkAttempts++;
                            if (checkAttempts >= maxAttempts) {
                                clearInterval(checkInterval);
                                console.log("播放器加载超时");
                            }
                        }
                    }, 500);
                }
                
                // 定义全局变量
                const progressContainer = document.querySelector('.progress-container');
                const progressBar = document.querySelector('.progress-bar');
                const progressThumb = document.querySelector('.progress-thumb');
                let isDragging = false;
                let wasPaused = true;
            }, 1000); // 延迟一秒等待原播放器加载
        });

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('comment_success')) {
                const toast = document.getElementById('success-toast');
                const toastMessage = document.getElementById('toast-message');
                toastMessage.textContent = "点评成功！";
                toast.classList.add('show');
                
                // 3秒后隐藏提示
                setTimeout(function() {
                    toast.classList.remove('show');
                    // 清除URL参数
                    let url = new URL(window.location.href);
                    url.searchParams.delete('comment_success');
                    history.replaceState({}, document.title, url);
                }, 3000);
            }
        });
    </script>
{% endblock %}