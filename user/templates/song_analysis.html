{% extends "title_base.html"  %}
{% load static %}
{% block title  %}
<link type="image/x-icon" rel="shortcut icon" href="{% static "favicon.ico" %}">
<link type="text/css" rel="stylesheet" href="{% static "css/common.css" %}">
<link type="text/css" rel="stylesheet" href="{% static "css/user.css" %}">
{% endblock %}

{% block content %}
<body class="member">
    <div class="header">
        <a href="/" class="logo" title="首页"><img src="{% static "image/logo2.png" %}"></a>
        <div class="search-bar-wrapper">
            <form class="search-form" id="searchForm" action="{% url 'search' 1 %}" method="post" target="_blank">
                {% csrf_token %}
                <input id="kword" name="kword" type="text" class="search-input" maxlength="120" placeholder="音乐节"/>
                <input id="subSerch" type="submit" class="search-btn" value="搜索" />
            </form>
            <div class="search-hot-words">
                {% for song in search_song  %}
                    <a target="play" href="{% url 'play' song.song.song_id %}">{{ song.song.song_name }}</a>
                {% endfor  %}
            </div>
        </div>
    </div>

    <div class="mod_profile js_user_data">
        <div class="section_inner user-profile-flex">
            <div class="user-profile-left">
                <div class="profile__cover_link">
                    <img src="{% static "image/2.png" %}" class="profile__cover">
                </div>
                <span class="profile__name" id="nickname-display">{{ user.nickname|default:user.username }}</span>
                <a href="{% url 'logout' %}" class="logout-link">退出登录</a>
            </div>
            <div class="user-profile-right">
                <div class="user-info">
                    <h2>个人信息</h2>
                    <form id="user-info-form" method="post" action="{% url 'update_user_info' %}">
                        {% csrf_token %}
                        <div class="user-info-rows">
                            <div class="user-info-row">
                                <div class="form-group">
                                    <label for="nickname">昵称：</label>
                                    <input type="text" id="nickname" name="nickname" value="{{ user.nickname|default:user.username }}">
                                </div>
                                <div class="form-group">
                                    <label for="email">邮箱：</label>
                                    <input type="email" id="email" name="email" value="{{ user.email }}">
                                </div>
                            </div>
                            <div class="user-info-row">
                                <div class="form-group">
                                    <label for="qq">QQ号：</label>
                                    <input type="text" id="qq" name="qq" value="{{ user.qq }}">
                                </div>
                                <div class="form-group">
                                    <label for="mobile">手机号：</label>
                                    <input type="text" id="mobile" name="mobile" value="{{ user.mobile }}">
                                </div>
                            </div>
                            <div class="user-info-row">
                                <div class="form-group" style="width: 100%;">
                                    <label for="bio">个性签名：</label>
                                    <input type="text" id="bio" name="bio" value="{{ user.bio }}">
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="save-btn">保存修改</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="main main--profile">
        <div class="mod_tab profile_nav" role="nav" id="nav">
            <a href="{% url 'home' 1 %}" class="mod_tab__item {% if request.resolver_match.url_name == 'home' %}mod_tab__current{% endif %}" id="hear_tab">我听过的歌</a>
            <a href="{% url 'song_analysis' %}" class="mod_tab__item {% if request.resolver_match.url_name == 'song_analysis' %}mod_tab__current{% endif %}" id="analysis_tab">我的歌曲分析</a>
        </div>
        <div class="js_box" style="display: block;">
            <div style="width: 80%; margin: 30px auto;">
                <h2>听歌时间-曲目数量折线图</h2>
                <div id="line_chart" style="width: 100%; height: 400px;"></div>
                <h2 style="margin-top:40px;">听过的歌曲类型分布饼图</h2>
                <div id="pie_chart" style="width: 100%; height: 400px;"></div>
            </div>
        </div>
    </div><!-- end main -->

    <!-- 引入 ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script>
        // 后端传递 line_labels, line_data, pie_data 给模板渲染
        var lineLabels = {{ line_labels|safe }};
        var lineData = {{ line_data|safe }};
        var pieData = {{ pie_data|safe }};

        // 动态设置纵轴最大值，使折线图自适应
        var maxCount = 5; // 默认最小刻度
        if (Array.isArray(lineData) && lineData.length > 0) {
            var realMax = Math.max.apply(null, lineData);
            maxCount = realMax < 5 ? 5 : realMax + 1; // 至少5，实际最大+1
        }

        // 折线图
        var lineChart = echarts.init(document.getElementById('line_chart'));
        var lineOption = {
            xAxis: { type: 'category', data: lineLabels, name: '日期' },
            yAxis: { 
                type: 'value', 
                name: '听过的歌曲数量',
                min: 0,
                max: maxCount,
                interval: Math.ceil(maxCount / 5) // 让y轴分隔更均匀
            },
            series: [{
                data: lineData,
                type: 'line',
                smooth: true
            }]
        };
        lineChart.setOption(lineOption);

        // 饼图
        var pieChart = echarts.init(document.getElementById('pie_chart'));
        var pieOption = {
            tooltip: { trigger: 'item' },
            legend: { top: '5%', left: 'center' },
            series: [{
                name: '类型分布',
                type: 'pie',
                radius: ['40%', '70%'],
                avoidLabelOverlap: false,
                data: pieData
            }]
        };
        pieChart.setOption(pieOption);
    </script>
</body>
{% endblock %}