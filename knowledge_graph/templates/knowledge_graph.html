{% extends "title_base.html" %}
{% load static %}
{% block title %}
<link type="image/x-icon" rel="shortcut icon" href="{% static "favicon.ico" %}">
<link type="text/css" rel="stylesheet" href="{% static "css/common.css" %}">
<link type="text/css" rel="stylesheet" href="{% static "css/index.css" %}">
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/qtip2/3.0.3/jquery.qtip.min.css">
<style>
  body { background: #fff7e6; }
  .kg-section { width: 92%; margin: 40px auto 0 auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 12px #f0f1f2; padding: 30px 30px 20px 30px; min-height: 700px;}
  .kg-header { font-size: 32px; font-weight: bold; letter-spacing: 2.5px; color: #363636; margin-bottom: 18px; margin-top: 10px; padding-left: 8px; border-left: 5px solid #4e54c8; line-height: 1.2;}
  .kg-controls { margin-bottom: 18px; display: flex; align-items: center; gap: 20px;}
  .kg-controls label { font-size: 16px; color: #444; margin-right: 7px;}
  .kg-controls select { padding: 6px 22px 6px 12px; font-size: 15px; border-radius: 6px; border: 1px solid #fbbd23; outline: none; background: #fffbe6; color: #c97a00; margin-right: 16px; min-width: 130px; font-weight: 500; appearance: none; box-shadow: 0 1px 4px #f9dbac1a; transition: border 0.2s;}
  .kg-controls select:focus { border: 1.5px solid #ff9800;}
  .kg-controls button { padding: 6px 28px; background: linear-gradient(90deg, #ffb74d, #ff9800); border: none; color: #fff; border-radius: 6px; font-size: 17px; font-weight: 600; cursor: pointer; transition: background 0.2s, box-shadow 0.2s; box-shadow: 0 1px 4px #ffecb31a; letter-spacing: 2px;}
  .kg-controls button:hover { background: linear-gradient(90deg, #ff9800, #ffb74d); box-shadow: 0 2px 8px #ffecb366;}
  .graph-area { position: relative; width: 100%; height: 700px; }
  #cy, #cy3d { width: 100%; height: 100%; position: absolute; left: 0; top: 0; }
  #cy { z-index: 2; }
  #cy3d { z-index: 1; }
  .kg-error { color: #d32f2f; font-size: 15px; margin: 30px 0 0 10px; font-weight: 500;}

  .header-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #fffbe6;
    padding: 0 40px;
    height: 72px;
    border-bottom: 2px solid #ffd24d;
    position: relative;
    z-index: 99;
  }
  .logo-box {
    flex: 0 0 auto;
  }
  .logo-img {
    height: 54px;
    margin-top: 5px;
  }
  .nav-menu {
    flex: 1 1 auto;
    display: flex;
    justify-content: center;
    gap: 16px;
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .nav-menu li a {
    font-size: 15px;
    color: #e1a100;
    text-decoration: none;
    font-weight: 500;
    padding: 8px 18px;
    border-radius: 8px;
    transition: background 0.2s, color 0.2s;
  }
  .nav-menu li a.active,
  .nav-menu li a:hover {
    background: #ffe0b2;
    color: #4e54c8;
  }
  .search-box {
    flex: 0 0 260px;
    display: flex;
    justify-content: flex-end;
  }
  .search-box form {
    display: flex;
    align-items: center;
    background: #fff9db;
    border-radius: 10px;
    padding: 2px 8px;
    border: 1.5px solid #ffe082;
  }
  .keyword {
    border: none;
    background: transparent;
    padding: 8px 12px;
    font-size: 16px;
    outline: none;
    width: 140px;
    color: #c97a00;
  }
  .search-button {
    background: #ffe082;
    color: #c97a00;
    border: none;
    border-radius: 7px;
    padding: 7px 20px;
    font-size: 15px;
    font-weight: 600;
    margin-left: 6px;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
  }
  .search-button:hover {
    background: #ffd24d;
    color: #4e54c8;
  }
</style>
{% endblock %}
{% block content %}
<!-- 顶部导航栏 -->
<div class="header-bar">
  <div class="logo-box">
    <a href="/"><img src="{% static 'image/logo2.png' %}" alt="logo" class="logo-img"></a>
  </div>
  <ul class="nav-menu">
    <li><a href="/">主页</a></li>
    <li><a href="{% url 'ranking' %}" target="_blank">歌曲排行榜</a></li>
    <li><a href="{% url 'knowledge_graph' %}" class="active">知识图谱可视化</a></li>
    <li><a href="{% url 'recommend:songs' %}" target="_blank">歌曲推荐</a></li>
    <li><a href="{% url 'aiassistant:assistant_page' %}" target="_blank">AI音乐助手</a></li>
    <li><a href="{% url 'home' 1 %}" target="_blank">用户</a></li>
  </ul>
  <div class="search-box">
    <form id="searchForm" action="{% url 'search' 1 %}" method="post" target="_blank">
      {% csrf_token %}
      <input name="kword" type="text" class="keyword" maxlength="120" placeholder="音乐节" />
      <input type="submit" class="search-button" value="搜 索" />
    </form>
  </div>
</div>

<div class="kg-section">
    <div class="kg-header">知识图谱可视化</div>
    <div class="kg-controls">
        <label for="kg-type">请选择图谱类型：</label>
        <select id="kg-type">
            <option value="artist-song">歌手-歌曲</option>
            <option value="song-album">歌曲-专辑</option>
            <option value="song-language">歌曲-语言</option>
        </select>
        <label for="kg-node" id="kg-node-label">请选择歌手：</label>
        <select id="kg-node"></select>
        <label for="kg-relation" id="kg-relation-label">请选择关系：</label>
        <select id="kg-relation"></select>
        <button type="button" onclick="loadGraph()">加载图谱</button>
        <button type="button" onclick="toggle3D()" id="toggle-3d-btn">切换3D/2D</button>
    </div>
    <div class="graph-area">
      <div id="cy"></div>
      <div id="cy3d"></div>
    </div>
    <div id="kg-error" class="kg-error" style="display:none;"></div>
</div>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/qtip2/3.0.3/jquery.qtip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape@3.25.0/dist/cytoscape.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-qtip@2.7.0/cytoscape-qtip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/3d-force-graph@1.73.0/dist/3d-force-graph.min.js"></script>
<script>
    let cy = null;
    let Graph3D = null;
    let use3DGraph = false;
    const typeToLabel = {
        "artist-song": "请选择歌手：",
        "song-album": "请选择专辑：",
        "song-language": "请选择语言："
    };

    function loadOptions() {
        const kgType = document.getElementById('kg-type').value;
        document.getElementById('kg-node-label').innerText = typeToLabel[kgType] || "请选择对象：";
        fetch(`/knowledge_graph/api/graph_options/?type=${kgType}`)
            .then(response => response.json())
            .then(data => {
                const nodeSelect = document.getElementById('kg-node');
                nodeSelect.innerHTML = '';
                data.nodes.forEach(node => {
                    const opt = document.createElement('option');
                    opt.value = node.id;
                    opt.text = node.name;
                    nodeSelect.appendChild(opt);
                });
                const relSelect = document.getElementById('kg-relation');
                relSelect.innerHTML = '';
                data.relations.forEach(rel => {
                    const opt = document.createElement('option');
                    opt.value = rel;
                    opt.text = rel;
                    relSelect.appendChild(opt);
                });
            });
    }

    function showError(msg) {
        document.getElementById('kg-error').innerText = msg;
        document.getElementById('kg-error').style.display = '';
        if (cy) cy.destroy();
        document.getElementById('cy').innerHTML = "";
        if (Graph3D) Graph3D.graphData({nodes:[], links:[]});
    }
    function hideError() {
        document.getElementById('kg-error').style.display = 'none';
    }

    function loadGraph() {
      hideError();
      const kgType = document.getElementById('kg-type').value;
      const nodeId = document.getElementById('kg-node').value;
      const relation = document.getElementById('kg-relation').value;
      if (!nodeId || !relation) {
        showError('请选择对象和关系类型');
        return;
      }
      fetch(`/knowledge_graph/api/graph/?type=${kgType}&node_id=${nodeId}&relation=${relation}`)
        .then(response => {
          if (!response.ok) throw new Error("服务器返回错误状态 " + response.status);
          return response.json();
        })
        .then(data => {
          if (!data.nodes || data.nodes.length === 0) {
            showError("暂无可视化数据，请更换类型或刷新后重试。");
            return;
          }
          if (use3DGraph) {
            show3DGraph(data.nodes, data.edges);
          } else {
            show2DGraph(data.nodes, data.edges);
          }
        })
        .catch(err => {
          showError("知识图谱数据加载失败：" + err);
          console.error("知识图谱数据加载失败：", err);
        });
    }

    function show2DGraph(nodes, edges) {
      document.getElementById('cy').style.zIndex = 2;
      document.getElementById('cy3d').style.zIndex = 1;
      if (cy) cy.destroy();

      const nodeIds = new Set(nodes.map(node => String(node.id)));
      const elements = [];
      nodes.forEach(node => {
        elements.push({
          data: {
            id: String(node.id),
            label: node.name ? node.name : String(node.id),
            group: node.labels && node.labels.length > 0 ? node.labels[0] : '',
            desc: node.desc || ''
          }
        });
      });
      edges.forEach(edge => {
        if (nodeIds.has(String(edge.source)) && nodeIds.has(String(edge.target))) {
          elements.push({
            data: {
              id: (edge.source.id ? String(edge.source.id) : String(edge.source)) + '_' +
                  (edge.target.id ? String(edge.target.id) : String(edge.target)) + '_' + edge.label,
              source: edge.source.id ? String(edge.source.id) : String(edge.source),
              target: edge.target.id ? String(edge.target.id) : String(edge.target),
              label: edge.label,
              desc: edge.desc || edge.label
            }
          });
        }
      });

      cy = cytoscape({
        container: document.getElementById('cy'),
        elements: elements,
        style: [
          {
            selector: 'node',
            style: {
              'label': 'data(label)',
              'background-color': '#4e54c8',
              'shape': 'ellipse',
              'color': '#fff',
              'text-valign': 'center',
              'text-halign': 'center',
              'font-size': 12,
              'width': 'label',
              'height': 'label',
              'padding': '8px',
              'border-width': 2,
              'border-color': '#fff',
              'text-wrap': 'wrap'
            }
          },
          { selector: 'node[group="Singer"]', style: {
              'background-color': '#ff9800',
              'border-color': '#fff3e0',
              'color': '#fff'
          }},
          { selector: 'node[group="Song"]', style: {
              'background-color': '#4e54c8',
              'border-color': '#d1d7fa',
              'color': '#fff'
          }},
          { selector: 'node[group="Album"]', style: {
              'background-color': '#00bcd4',
              'border-color': '#b2ebf2',
              'color': '#fff'
          }},
          { selector: 'node[group="Language"]', style: {
              'background-color': '#43a047',
              'border-color': '#c8e6c9',
              'color': '#fff'
          }},
          { selector: 'edge', style: {
              'label': 'data(label)',
              'font-size': 11,
              'text-rotation': 'autorotate',
              'text-margin-y': -10,
              'width': 1.8,
              'line-color': '#c4cfff',
              'target-arrow-shape': 'triangle',
              'target-arrow-color': '#c4cfff',
              'curve-style': 'bezier',
              'opacity': 0.7
            }
          }
        ],
        layout: {
          name: 'cose',
          fit: true,
          animate: false,
          nodeRepulsion: 2400,
          idealEdgeLength: 120,
          edgeElasticity: 120
        }
      });

      // 悬停高亮
      cy.on('mouseover', 'node', function(evt){
        const node = evt.target;
        node.addClass('hovered');
        node.connectedEdges().addClass('hovered');
      });
      cy.on('mouseout', 'node', function(evt){
        const node = evt.target;
        node.removeClass('hovered');
        node.connectedEdges().removeClass('hovered');
      });
      cy.style()
        .selector('node.hovered')
        .style({
          'border-width': 5,
          'border-color': '#ff9800',
          'z-index': 999
        })
        .selector('edge.hovered')
        .style({
          'width': 4,
          'line-color': '#ff9800',
          'target-arrow-color': '#ff9800',
          'opacity': 1
        })
        .update();

      // 悬停显示描述
      cy.nodes().forEach(function(ele){
          if(ele.data('desc')){
              ele.qtip({
                  content: ele.data('desc'),
                  show: { event: 'mouseover' },
                  hide: { event: 'mouseout unfocus' },
                  position: { my: 'top center', at: 'bottom center' },
                  style: { classes: 'qtip-bootstrap', tip: { width: 16, height: 8 } }
              });
          }
      });
      cy.edges().forEach(function(ele){
          if(ele.data('desc')){
              ele.qtip({
                  content: ele.data('desc'),
                  show: { event: 'mouseover' },
                  hide: { event: 'mouseout unfocus' },
                  position: { my: 'top center', at: 'bottom center' },
                  style: { classes: 'qtip-bootstrap', tip: { width: 16, height: 8 } }
              });
          }
      });
    }

    function show3DGraph(nodes, edges) {
      document.getElementById('cy').style.zIndex = 1;
      document.getElementById('cy3d').style.zIndex = 2;

      let data3d = {
        nodes: nodes.map(n => ({
          ...n,
          id: String(n.id),
          name: n.name || n.label || n.id,
          group: n.labels && n.labels.length > 0 ? n.labels[0] : ''
        })),
        links: edges.map(e => ({
          ...e,
          source: e.source.id ? String(e.source.id) : String(e.source),
          target: e.target.id ? String(e.target.id) : String(e.target),
          label: e.label
        }))
      };

      if (!Graph3D) {
        Graph3D = ForceGraph3D()(document.getElementById('cy3d'))
          .nodeLabel(node => node.name || node.id)
          .nodeAutoColorBy('group')
          .linkLabel(link => link.label || '')
          .backgroundColor('#fafcff')
          .linkDirectionalParticles(2)
          .linkDirectionalParticleWidth(2);

        window.addEventListener('resize', () => {
          Graph3D.width(document.getElementById('cy3d').offsetWidth);
          Graph3D.height(document.getElementById('cy3d').offsetHeight);
        });
      }
      Graph3D.graphData(data3d);
    }

    function toggle3D() {
      use3DGraph = !use3DGraph;
      document.getElementById('toggle-3d-btn').innerText = use3DGraph ? '切换2D' : '切换3D';
      loadGraph();
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadOptions();
        document.getElementById('kg-type').addEventListener('change', loadOptions);
    });
</script>
{% endblock %}